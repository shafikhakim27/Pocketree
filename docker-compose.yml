services:
  # 1. DATABASE (MySQL)
  pocketree-db:
    image: mysql:8.0
    container_name: pocketree-db
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_PASSWORD:-rootpassword}
      - MYSQL_DATABASE=${DB_NAME:-pocketree}
    ports:
      # Maps internal 3306 to external 3307 (default) to avoid conflicts
      - "${DB_PORT:-3306}:3306"
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - pocketree-net
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # 2. BACKEND API (.NET)
  pocketree-api:
    build:
      context: .
      dockerfile: src/Pocketree.Api/Dockerfile
    container_name: pocketree-api
    restart: always
    ports:
      - "${API_PORT:-5042}:8080"
    environment:
      # Forces container to use internal DB name, ignoring any local appsettings files
      - ConnectionStrings__DefaultConnection=Server=pocketree-db;Port=3306;Database=${DB_NAME:-pocketree};User=root;Password=${DB_PASSWORD:-rootpassword};
      - ML_SERVICE_URL=http://ml-service:8000
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - Jwt__Key=${JWT_KEY:-DevelopmentSecretKey_AtLeast32CharactersLong!!}
      - Jwt__Issuer=${JWT_ISSUER:-PocketreeApi}
      - Jwt__Audience=${JWT_AUDIENCE:-PocketreeApiUsers}
    depends_on:
      pocketree-db:
        condition: service_healthy
    networks:
      - pocketree-net

  # 3. ML SERVICE (Python)
  ml-service:
    build:
      context: ml-service
      dockerfile: Dockerfile
    container_name: ml-service
    restart: always
    ports:
      - "${ML_PORT:-8000}:8000"
    environment:
      - ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      # These variables are here for when you eventually update the Python script
      - DB_HOST=pocketree-db
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=rootpassword
      - DB_NAME=pocketree
    networks:
      - pocketree-net
    # Optional: Basic healthcheck to ensure Flask/FastAPI is responsive
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/"] 
      timeout: 10s
      retries: 3
      interval: 10s

  # 4. JENKINS (CI/CD)
  jenkins:
    build:
      context: .
      dockerfile: Dockerfile.jenkins
    container_name: pocketree-jenkins
    restart: always
    privileged: true
    user: root
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - pocketree-net

  # 5. SONARQUBE (Code Quality)
  sonarqube:
    image: sonarqube:lts-community
    container_name: sonarqube
    restart: always
    ports:
      - "9000:9000"
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
    volumes:
      - sonar_data:/opt/sonarqube/data
      - sonar_extensions:/opt/sonarqube/extensions
      - sonar_logs:/opt/sonarqube/logs
    networks:
      - pocketree-net

volumes:
  db_data:
  jenkins_home:
  sonar_data:
  sonar_extensions:
  sonar_logs:

networks:
  pocketree-net:
    name: fixed-pocketree-network
    driver: bridge